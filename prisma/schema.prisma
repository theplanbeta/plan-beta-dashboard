generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String          @id @default(cuid())
  email                 String          @unique
  name                  String
  password              String
  role                  UserRole        @default(TEACHER)
  active                Boolean         @default(true)
  phone                 String?
  avatar                String?
  bio                   String?
  qualifications        String?
  experience            String?
  specializations       String?
  languages             String?
  availability          String?
  availableMorning      Boolean?        @default(true)
  availableEvening      Boolean?        @default(true)
  preferredContact      String?
  teacherLevels         String[]
  teacherTimings        String[]
  teacherTimeSlots      Json?
  hourlyRate            Json?
  currency              String?         @default("EUR")
  whatsapp              String?
  remarks               String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  passwordResetExpiry   DateTime?
  passwordResetToken    String?
  requirePasswordChange Boolean         @default(false)
  welcomeToken          String?
  welcomeTokenExpiry    DateTime?
  batches               Batch[]         @relation("TeacherBatches")
  leads                 Lead[]
  offerLetters          OfferLetter[]   @relation("TeacherOffers")
  teacherHours          TeacherHours[]  @relation("TeacherHours")
  teacherReviews        TeacherReview[] @relation("TeacherReviewer")

  @@index([email])
  @@index([role])
  @@index([active])
  @@index([passwordResetToken])
  @@index([welcomeToken])
}

model Student {
  id                   String               @id @default(cuid())
  studentId            String               @unique
  name                 String
  whatsapp             String               @unique
  email                String?              @unique
  enrollmentDate       DateTime             @default(now())
  currentLevel         Level                @default(NEW)
  isCombo              Boolean              @default(false)
  comboLevels          String[]
  batchId              String?
  originalPrice        Decimal              @db.Decimal(10, 2)
  discountApplied      Decimal              @default(0) @db.Decimal(10, 2)
  finalPrice           Decimal              @db.Decimal(10, 2)
  currency             String               @default("EUR")
  eurEquivalent        Decimal?             @db.Decimal(10, 2)
  exchangeRateUsed     Decimal?             @db.Decimal(10, 4)
  paymentStatus        PaymentStatus        @default(PENDING)
  totalPaid            Decimal              @default(0) @db.Decimal(10, 2)
  totalPaidEur         Decimal?             @db.Decimal(10, 2)
  balance              Decimal              @default(0) @db.Decimal(10, 2)
  referralSource       ReferralSource
  referredById         String?
  trialAttended        Boolean              @default(false)
  trialDate            DateTime?
  classesAttended      Int                  @default(0)
  totalClasses         Int                  @default(0)
  attendanceRate       Decimal              @default(0) @db.Decimal(5, 2)
  lastClassDate        DateTime?
  avgQuizScore         Decimal?             @db.Decimal(5, 2)
  completionStatus     CompletionStatus     @default(ACTIVE)
  churnRisk            ChurnRisk            @default(LOW)
  notes                String?
  emailNotifications   Boolean              @default(true)
  emailWelcome         Boolean              @default(true)
  emailPayment         Boolean              @default(true)
  emailAttendance      Boolean              @default(true)
  emailBatch           Boolean              @default(true)
  emailReferral        Boolean              @default(true)
  // Demographics for smart outreach filtering
  city                 String?
  profession           String?
  dateOfBirth          DateTime?
  age                  Int?
  // Germany Relocation Support
  relocatingToGermany    Boolean         @default(false)
  relocationTimeline     String?         // e.g., "3_MONTHS", "6_MONTHS", "1_YEAR", "ALREADY_IN_GERMANY"
  destinationCity        String?         // Target city in Germany
  visaStatus             String?         // e.g., "NOT_APPLIED", "APPLIED", "APPROVED", "IN_GERMANY"
  relocationSupportNeeded String[]       // e.g., ["HOUSING", "JOB_SEARCH", "BUREAUCRACY", "NETWORKING"]
  referralCode         String?              @unique // Public referral code e.g. "DEEPAK-PB-7X3K"
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  consecutiveAbsences  Int                  @default(0)
  lastAbsenceDate      DateTime?
  churnMitigatedAt     DateTime?
  previousBatchId      String?
  suspendedAt          DateTime?
  suspensionReason     String?
  lastOutreachCall     DateTime?
  relationshipDepth    Int                  @default(0)
  attendance           Attendance[]
  contentComments      ContentComment[]     @relation("StudentComments")
  contentPosts         ContentPost[]        @relation("StudentPosts")
  invoices             Invoice[]
  convertedFromLead    Lead?
  outreachCalls        OutreachCall[]       @relation("StudentOutreachCalls")
  payments             Payment[]
  referralsReceived    Referral[]           @relation("RefereeStudent")
  referralsGiven       Referral[]           @relation("ReferrerStudent")
  refunds              Refund[]
  batch                Batch?               @relation(fields: [batchId], references: [id])
  referredBy           Student?             @relation("StudentReferrals", fields: [referredById], references: [id])
  referrals            Student[]            @relation("StudentReferrals")
  connectedWith        StudentConnection[]  @relation("ConnectedWith")
  communityConnections StudentConnection[]  @relation("StudentConnections")
  interactions         StudentInteraction[] @relation("StudentInteractions")
  teacherReviews       TeacherReview[]      @relation("StudentTeacherReviews")
  upsells              Upsell[]
  enrollments          BatchEnrollment[]

  @@index([studentId])
  @@index([whatsapp])
  @@index([email])
  @@index([batchId])
  @@index([enrollmentDate])
  @@index([paymentStatus])
  @@index([churnRisk])
  @@index([currentLevel])
  @@index([referredById])
  @@index([suspendedAt])
  @@index([lastOutreachCall])
}

model StudentInteraction {
  id              String              @id @default(cuid())
  studentId       String
  userId          String
  userName        String
  interactionType InteractionType
  category        InteractionCategory
  notes           String
  outcome         String?
  followUpDate    DateTime?
  followUpNeeded  Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  student         Student             @relation("StudentInteractions", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([userId])
  @@index([interactionType])
  @@index([category])
  @@index([followUpNeeded])
  @@index([followUpDate])
  @@index([createdAt])
}

model Batch {
  id            String         @id @default(cuid())
  batchCode     String         @unique
  level         Level
  startDate     DateTime?
  endDate       DateTime?
  schedule      String?
  teacherId     String?
  totalSeats    Int            @default(10)
  enrolledCount Int            @default(0)
  fillRate      Decimal        @default(0) @db.Decimal(5, 2)
  status        BatchStatus    @default(PLANNING)
  currency      String         @default("EUR")
  revenueTarget Decimal        @default(0) @db.Decimal(10, 2)
  revenueActual Decimal        @default(0) @db.Decimal(10, 2)
  teacherCost   Decimal        @default(0) @db.Decimal(10, 2)
  profit        Decimal        @default(0) @db.Decimal(10, 2)
  fillWarning   Boolean        @default(false)
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  autoRecord    Boolean        @default(false)
  meetLink      String?
  timing        String?
  teacher       User?          @relation("TeacherBatches", fields: [teacherId], references: [id])
  leads         Lead[]
  recordingLogs RecordingLog[]
  students      Student[]
  teacherHours  TeacherHours[] @relation("BatchHours")
  enrollments   BatchEnrollment[]

  @@index([batchCode])
  @@index([level])
  @@index([status])
  @@index([startDate])
  @@index([teacherId])
  @@index([timing])
  @@index([autoRecord])
}

model BatchEnrollment {
  id             String           @id @default(cuid())
  studentId      String
  batchId        String
  enrollmentDate DateTime         @default(now())
  status         CompletionStatus @default(ACTIVE)
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  student        Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  batch          Batch            @relation(fields: [batchId], references: [id])

  @@unique([studentId, batchId])
  @@index([studentId])
  @@index([batchId])
}

model Attendance {
  id        String           @id @default(cuid())
  date      DateTime         @db.Date
  status    AttendanceStatus @default(ABSENT)
  studentId String
  notes     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
  @@index([studentId])
  @@index([date])
  @@index([status])
}

model Payment {
  id            String            @id @default(cuid())
  amount        Decimal           @db.Decimal(10, 2)
  paymentDate   DateTime          @default(now())
  method        PaymentMethod
  status        TransactionStatus @default(PENDING)
  currency      String            @default("EUR")
  transactionId String?
  invoiceNumber String?           @unique
  invoiceSent   Boolean           @default(false)
  invoiceUrl    String?
  studentId     String
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  student       Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  receipts      Receipt[]
  refunds       Refund[]

  @@index([studentId])
  @@index([paymentDate])
  @@index([status])
  @@index([invoiceNumber])
  @@index([transactionId])
}

model Receipt {
  id               String    @id @default(cuid())
  receiptNumber    String    @unique
  paymentId        String
  studentId        String
  date             DateTime  @default(now())
  currency         String    @default("EUR")
  amountPaid       Decimal   @db.Decimal(10, 2)
  totalAmount      Decimal   @db.Decimal(10, 2)
  balanceRemaining Decimal   @db.Decimal(10, 2)
  paymentMethod    String
  transactionRef   String?
  invoiceNumber    String?
  courseItems      Json
  pdfPath          String?
  jpgPath          String?
  pdfSize          Int?
  jpgSize          Int?
  downloadCount    Int       @default(0)
  lastAccessedAt   DateTime?
  sentToEmail      String?
  emailSentAt      DateTime?
  whatsappSent     Boolean   @default(false)
  whatsappSentAt   DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  jpgData          Bytes?
  pdfData          Bytes?
  payment          Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([receiptNumber])
  @@index([paymentId])
  @@index([studentId])
  @@index([date])
  @@index([lastAccessedAt])
}

model Refund {
  id                  String        @id @default(cuid())
  studentId           String
  paymentId           String?
  refundAmount        Decimal       @db.Decimal(10, 2)
  currency            String        @default("EUR")
  refundDate          DateTime      @default(now())
  refundMethod        PaymentMethod
  refundReason        RefundReason
  processedByUserId   String
  processedByUserName String
  transactionId       String?
  status              RefundStatus  @default(PENDING)
  notes               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  payment             Payment?      @relation(fields: [paymentId], references: [id])
  student             Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([paymentId])
  @@index([refundDate])
  @@index([status])
  @@index([processedByUserId])
}

model Referral {
  id             String       @id @default(cuid())
  referralDate   DateTime     @default(now())
  referrerId     String
  refereeId      String
  enrollmentDate DateTime?
  month1Complete Boolean      @default(false)
  payoutAmount   Decimal      @default(2000) @db.Decimal(10, 2)
  payoutStatus   PayoutStatus @default(PENDING)
  payoutDate     DateTime?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  referee        Student      @relation("RefereeStudent", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer       Student      @relation("ReferrerStudent", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, refereeId])
  @@index([referrerId])
  @@index([refereeId])
  @@index([payoutStatus])
  @@index([month1Complete])
}

model Upsell {
  id                String    @id @default(cuid())
  fromLevel         Level
  toLevel           Level
  studentId         String
  currentProgress   Decimal   @default(0) @db.Decimal(5, 2)
  emailsSent        Int       @default(0)
  lastEmailDate     DateTime?
  converted         Boolean   @default(false)
  conversionDate    DateTime?
  additionalRevenue Decimal?  @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  student           Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([converted])
  @@index([currentProgress])
}

model EmailQueue {
  id           String    @id @default(cuid())
  to           String
  subject      String
  templateType String
  templateData Json
  scheduledFor DateTime
  sentAt       DateTime?
  status       String    @default("PENDING")
  opened       Boolean   @default(false)
  clicked      Boolean   @default(false)
  attempts     Int       @default(0)
  lastError    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([to])
}

model DailyMetrics {
  id                  String   @id @default(cuid())
  date                DateTime @unique @db.Date
  dailyRevenue        Decimal  @default(0) @db.Decimal(10, 2)
  monthlyRevenue      Decimal  @default(0) @db.Decimal(10, 2)
  newEnrollments      Int      @default(0)
  totalActiveStudents Int      @default(0)
  batchesFull         Int      @default(0)
  batchesFilling      Int      @default(0)
  batchesRunning      Int      @default(0)
  studentsAtRisk      Int      @default(0)
  studentsDropped     Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([date])
}

model Lead {
  id                  String              @id @default(cuid())
  name                String
  whatsapp            String
  email               String?
  phone               String?
  source              ReferralSource
  status              LeadStatus          @default(NEW)
  quality             LeadQuality         @default(WARM)
  interestedLevel     Level?
  interestedCombo     Boolean?
  interestedLevels    String[]            @default([])
  firstContactDate    DateTime            @default(now())
  lastContactDate     DateTime?
  trialScheduledDate  DateTime?
  trialAttendedDate   DateTime?
  converted           Boolean             @default(false)
  convertedDate       DateTime?
  studentId           String?             @unique
  batchId             String?
  interestedMonth     String?
  interestedBatchTime String?
  followUpDate        DateTime?
  followUpNotes       String?
  contactAttempts     Int                 @default(0)
  notes               String?
  assignedToId        String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  contentInteractions Json?
  firstTouchpoint     String?
  instagramHandle     String?
  leadScore           Int                 @default(0)
  socialEngagement    Json?
  sourceReelId        String?
  sourceReelUrl       String?

  // Website tracking & attribution
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmContent          String?
  utmTerm             String?
  referrerUrl         String?
  landingPage         String?
  deviceType          String?
  visitorId           String?
  referralCode        String?             // Referral code used by this lead

  invoices            Invoice[]
  assignedTo          User?               @relation(fields: [assignedToId], references: [id])
  interestedBatch     Batch?              @relation(fields: [batchId], references: [id])
  sourceContent       ContentPerformance? @relation("ContentLeads", fields: [sourceReelId], references: [contentId])
  convertedToStudent  Student?            @relation(fields: [studentId], references: [id])

  @@index([status])
  @@index([quality])
  @@index([source])
  @@index([converted])
  @@index([assignedToId])
  @@index([batchId])
  @@index([instagramHandle])
  @@index([sourceReelId])
  @@index([leadScore])
  @@index([convertedDate])
  @@index([status, createdAt])
  @@index([utmCampaign])
  @@index([visitorId])
  @@index([landingPage])
}

model AuditLog {
  id            String        @id @default(cuid())
  action        AuditAction
  severity      AuditSeverity @default(INFO)
  userId        String?
  userEmail     String?
  userName      String?
  ipAddress     String?
  userAgent     String?
  entityType    String?
  entityId      String?
  description   String
  metadata      Json?
  requestPath   String?
  requestMethod String?
  statusCode    Int?
  errorMessage  String?
  errorStack    String?
  createdAt     DateTime      @default(now())

  @@index([action])
  @@index([severity])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  date            DateTime      @default(now())
  dueDate         DateTime
  currency        String        @default("EUR")
  status          InvoiceStatus @default(DRAFT)
  totalAmount     Decimal       @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @db.Decimal(10, 2)
  remainingAmount Decimal       @db.Decimal(10, 2)
  items           Json
  leadId          String?
  studentId       String?
  pdfUrl          String?
  jpgUrl          String?
  sentToEmail     String?
  emailSentAt     DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lead            Lead?         @relation(fields: [leadId], references: [id])
  student         Student?      @relation(fields: [studentId], references: [id])

  @@index([invoiceNumber])
  @@index([leadId])
  @@index([studentId])
  @@index([status])
  @@index([date])
}

model ConversionAttempt {
  id             String   @id @default(cuid())
  idempotencyKey String   @unique
  invoiceId      String
  leadId         String
  studentId      String?
  paidAmount     Decimal  @db.Decimal(10, 2)
  currency       String
  batchId        String?
  isCombo        Boolean?
  comboLevels    String[] @default([])
  status         String   @default("PENDING")
  errorMessage   String?
  userId         String?
  userEmail      String?
  result         Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([invoiceId])
  @@index([leadId])
  @@index([studentId])
  @@index([status])
  @@index([createdAt])
}

model TeacherHours {
  id              String    @id @default(cuid())
  teacherId       String
  batchId         String?
  date            DateTime  @db.Date
  hoursWorked     Decimal   @db.Decimal(5, 2)
  description     String
  hourlyRate      Decimal?  @db.Decimal(10, 2)
  totalAmount     Decimal   @db.Decimal(10, 2)
  paid            Boolean   @default(false)
  paidDate        DateTime?
  paidAmount      Decimal?  @db.Decimal(10, 2)
  paymentNotes    String?
  status          String    @default("PENDING")
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  batch           Batch?    @relation("BatchHours", fields: [batchId], references: [id])
  teacher         User      @relation("TeacherHours", fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([batchId])
  @@index([date])
  @@index([status])
  @@index([paid])
}

model TeacherReview {
  id        String   @id @default(cuid())
  studentId String
  teacherId String
  rating    Int?
  category  String?
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation("StudentTeacherReviews", fields: [studentId], references: [id], onDelete: Cascade)
  teacher   User     @relation("TeacherReviewer", fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([teacherId])
  @@index([createdAt])
}

model ContentPerformance {
  id             String   @id @default(cuid())
  platform       String
  contentType    String
  contentId      String   @unique
  contentUrl     String
  publishedAt    DateTime
  views          Int      @default(0)
  likes          Int      @default(0)
  comments       Int      @default(0)
  shares         Int      @default(0)
  saves          Int      @default(0)
  leadsGenerated Int      @default(0)
  enrollments    Int      @default(0)
  revenue        Decimal  @default(0) @db.Decimal(10, 2)
  caption        String?
  hashtags       String[]
  topic          String?
  engagementRate Decimal? @db.Decimal(5, 2)
  conversionRate Decimal? @db.Decimal(5, 2)
  roi            Decimal? @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  reach          Int      @default(0)
  leads          Lead[]   @relation("ContentLeads")

  @@index([platform])
  @@index([contentType])
  @@index([publishedAt])
  @@index([topic])
  @@index([engagementRate])
  @@index([conversionRate])
}

model RecordingLog {
  id                String          @id @default(cuid())
  batchId           String
  batchCode         String
  meetLink          String
  scheduledTime     DateTime
  startedAt         DateTime?
  status            RecordingStatus @default(PENDING)
  recordingVerified Boolean         @default(false)
  errorMessage      String?
  screenshot        String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  batch             Batch           @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([scheduledTime])
  @@index([status])
  @@index([createdAt])
}

model Subreddit {
  id               String       @id @default(cuid())
  name             String       @unique
  description      String?
  category         String?
  active           Boolean      @default(true)
  lastFetched      DateTime?
  postCount        Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  currentTimeframe String       @default("week")
  posts            RedditPost[]

  @@index([active])
  @@index([name])
}

model RedditPost {
  id            String        @id @default(cuid())
  redditId      String        @unique
  subredditId   String
  subredditName String
  title         String
  selftext      String?
  author        String
  url           String
  permalink     String
  upvotes       Int           @default(0)
  numComments   Int           @default(0)
  postedAt      DateTime
  fetchedAt     DateTime      @default(now())
  saved         Boolean       @default(false)
  analyzed      Boolean       @default(false)
  createdAt     DateTime      @default(now())
  contentIdeas  ContentIdea[]
  subreddit     Subreddit     @relation(fields: [subredditId], references: [id], onDelete: Cascade)

  @@index([subredditId])
  @@index([saved])
  @@index([postedAt])
  @@index([upvotes])
}

model ContentIdea {
  id                String     @id @default(cuid())
  redditPostId      String
  hook              String
  script            String
  visualSuggestions String
  caption           String
  hashtags          String[]
  topic             String
  status            String     @default("DRAFT")
  notes             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  redditPost        RedditPost @relation(fields: [redditPostId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt])
}

model OfferLetter {
  id                 String      @id @default(cuid())
  offerNumber        String      @unique
  teacherId          String
  teacherAddress     String
  offerDate          DateTime
  acceptanceDeadline DateTime
  positionType       String      @default("PART_TIME")
  batchAssignments   Json
  status             OfferStatus @default(DRAFT)
  sentAt             DateTime?
  viewedAt           DateTime?
  pdfUrl             String?
  pdfData            Bytes?
  createdBy          String
  createdByEmail     String
  notes              String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  teacher            User        @relation("TeacherOffers", fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([status])
  @@index([offerDate])
  @@index([offerNumber])
}

model ContentPost {
  id          String           @id @default(cuid())
  studentId   String
  title       String
  content     String
  contentType ContentType
  level       Level?
  language    String           @default("de")
  status      PostStatus       @default(PUBLISHED)
  viewCount   Int              @default(0)
  featured    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  comments    ContentComment[]
  likes       ContentLike[]
  student     Student          @relation("StudentPosts", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([contentType])
  @@index([status])
  @@index([level])
  @@index([featured])
  @@index([createdAt])
}

model ContentLike {
  id        String      @id @default(cuid())
  postId    String
  studentId String
  createdAt DateTime    @default(now())
  post      ContentPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, studentId])
  @@index([postId])
  @@index([studentId])
}

model ContentComment {
  id        String      @id @default(cuid())
  postId    String
  studentId String
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  post      ContentPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  student   Student     @relation("StudentComments", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([studentId])
  @@index([createdAt])
}

model OutreachCall {
  id              String             @id @default(cuid())
  studentId       String
  scheduledDate   DateTime           @db.Date
  priority        OutreachPriority   @default(MEDIUM)
  status          OutreachStatus     @default(PENDING)
  callType        OutreachCallType
  purpose         String
  preCallNotes    String?
  completedAt     DateTime?
  duration        Int?
  callNotes       String?
  journeyUpdates  Json?
  sentiment       OutreachSentiment?
  nextCallDate    DateTime?          @db.Date
  snoozedUntil    DateTime?          @db.Date
  snoozeReason    String?
  attemptCount    Int                @default(0)
  createdBy       String
  createdByName   String
  completedBy     String?
  completedByName String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  student         Student            @relation("StudentOutreachCalls", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([scheduledDate])
  @@index([status])
  @@index([priority])
  @@index([callType])
  @@index([createdBy])
  @@index([studentId, scheduledDate, status])
}

model StudentConnection {
  id                 String           @id @default(cuid())
  studentId          String
  connectedStudentId String
  reason             String
  introducedAt       DateTime         @default(now())
  introducedBy       String
  introducedByName   String
  status             ConnectionStatus @default(INTRODUCED)
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  connectedStudent   Student          @relation("ConnectedWith", fields: [connectedStudentId], references: [id], onDelete: Cascade)
  student            Student          @relation("StudentConnections", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, connectedStudentId])
  @@index([studentId])
  @@index([connectedStudentId])
  @@index([status])
  @@index([introducedAt])
}

enum RecordingStatus {
  PENDING
  STARTED
  RECORDING
  COMPLETED
  FAILED
  VERIFICATION_FAILED
}

enum UserRole {
  FOUNDER
  MARKETING
  TEACHER
}

enum Level {
  NEW
  A1
  A2
  B1
  B2
  SPOKEN_GERMAN
  A1_HYBRID_MALAYALAM
  A1_HYBRID
}

enum PaymentStatus {
  PAID
  PENDING
  PARTIAL
  OVERDUE
}

enum PaymentMethod {
  BANK_TRANSFER
  UPI
  CASH
  CARD
  OTHER
}

enum TransactionStatus {
  COMPLETED
  PENDING
  FAILED
  REFUNDED
}

enum ReferralSource {
  META_ADS
  INSTAGRAM
  GOOGLE
  ORGANIC
  REFERRAL
  OTHER
}

enum BatchStatus {
  PLANNING
  FILLING
  FULL
  RUNNING
  COMPLETED
  POSTPONED
  CANCELLED
}

enum ChurnRisk {
  LOW
  MEDIUM
  HIGH
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum CompletionStatus {
  ACTIVE
  COMPLETED
  DROPPED
  ON_HOLD
  SUSPENDED
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  TRIAL_SCHEDULED
  TRIAL_ATTENDED
  CONVERTED
  LOST
}

enum LeadQuality {
  HOT
  WARM
  COLD
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
}

enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  LEAD_CREATED
  LEAD_UPDATED
  LEAD_DELETED
  LEAD_CONVERTED
  INVOICE_GENERATED
  INVOICE_SENT
  INVOICE_UPDATED
  INVOICE_CANCELLED
  PAYMENT_RECEIVED
  STUDENT_CREATED
  LEAD_TO_STUDENT_CONVERSION
  STUDENT_UPDATED
  STUDENT_DELETED
  BATCH_CREATED
  BATCH_UPDATED
  BATCH_DELETED
  TEACHER_CREATED
  TEACHER_UPDATED
  TEACHER_ACTIVATED
  TEACHER_DEACTIVATED
  TEACHER_HOURS_LOGGED
  TEACHER_HOURS_APPROVED
  TEACHER_HOURS_REJECTED
  TEACHER_HOURS_PAID
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  SYSTEM_ERROR
  DATABASE_ERROR
  API_ERROR
  EMAIL_SENT
  EMAIL_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  TEACHER_DELETED
  RECEIPT_GENERATED
  RECEIPT_DOWNLOADED
  RECEIPT_SENT
  REFUND_PROCESSED
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum InteractionType {
  PHONE_CALL
  WHATSAPP
  EMAIL
  IN_PERSON
  SMS
  OTHER
}

enum InteractionCategory {
  CHURN_OUTREACH
  PAYMENT_REMINDER
  ATTENDANCE_FOLLOW_UP
  GENERAL_CHECK_IN
  COMPLAINT_RESOLUTION
  COURSE_INQUIRY
  FEEDBACK_REQUEST
  REFERRAL_DISCUSSION
  OTHER
}

enum RefundStatus {
  PENDING
  PROCESSED
  CANCELLED
}

enum RefundReason {
  STUDENT_WITHDRAWAL
  OVERPAYMENT
  SERVICE_ISSUE
  DUPLICATE_PAYMENT
  BATCH_CANCELLED
  OTHER
}

enum OfferStatus {
  DRAFT
  GENERATED
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum ContentType {
  STORY
  POEM
  ESSAY
  LETTER
  DIALOGUE
  VOCABULARY
  GRAMMAR_TIP
  OTHER
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OutreachPriority {
  LOW
  MEDIUM
  HIGH
}

enum OutreachStatus {
  PENDING
  COMPLETED
  SNOOZED
  CANCELLED
}

enum OutreachCallType {
  ONBOARDING
  CHECK_IN
  MILESTONE
  SUPPORT
  FEEDBACK
  COMMUNITY
  RETENTION
  OTHER
}

// ========================================
// 10x Roadmap Models
// ========================================

model Notification {
  id        String    @id @default(cuid())
  type      String    // NEW_LEAD, PAYMENT_RECEIVED, RETENTION_ALERT, WHATSAPP_INBOUND
  title     String
  message   String
  metadata  Json?
  read      Boolean   @default(false)
  readAt    DateTime?
  userId    String?   // null = visible to all FOUNDERs
  createdAt DateTime  @default(now())

  @@index([read])
  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

enum OutreachSentiment {
  VERY_POSITIVE
  POSITIVE
  NEUTRAL
  NEGATIVE
  VERY_NEGATIVE
}

enum ConnectionStatus {
  INTRODUCED
  CONNECTED
  ACTIVE
  INACTIVE
}

enum ExpenseType {
  RECURRING
  ONE_TIME
}

enum ExpenseCategory {
  INFRASTRUCTURE
  TOOLS_SOFTWARE
  MARKETING
  ADMINISTRATIVE
  OTHER
}

model Expense {
  id               String          @id @default(cuid())
  name             String
  amount           Decimal         @db.Decimal(10, 2)
  currency         String          @default("EUR")
  eurEquivalent    Decimal?        @db.Decimal(10, 2)
  exchangeRateUsed Decimal?        @db.Decimal(10, 4)
  category         ExpenseCategory
  type             ExpenseType
  date             DateTime        @db.Date
  notes            String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([category])
  @@index([type])
  @@index([date])
  @@index([isActive])
}

model WhatsAppMessage {
  id              String    @id @default(cuid())
  direction       String    // OUTBOUND, INBOUND
  whatsappId      String?   @unique
  phoneNumber     String
  templateName    String?
  messageText     String?
  status          String    @default("SENT") // SENT, DELIVERED, READ, FAILED
  statusTimestamp DateTime?
  leadId          String?
  studentId       String?
  metadata        Json?
  errorMessage    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([phoneNumber])
  @@index([leadId])
  @@index([studentId])
  @@index([createdAt])
}

model RazorpayOrder {
  id                String   @id @default(cuid())
  razorpayOrderId   String   @unique
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("INR")
  status            String   @default("CREATED") // CREATED, PAID, FAILED
  level             String?
  customerName      String
  customerEmail     String?
  customerPhone     String
  razorpayPaymentId String?
  razorpaySignature String?
  studentId         String?
  leadId            String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([razorpayOrderId])
  @@index([status])
  @@index([studentId])
  @@index([createdAt])
}

model PushSubscription {
  id         String   @id @default(cuid())
  endpoint   String   @unique
  p256dh     String
  auth       String
  studentId  String?
  leadId     String?
  userId     String?
  topics     String[] @default([])
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([studentId])
  @@index([userId])
  @@index([active])
}

model AdSpend {
  id           String   @id @default(cuid())
  platform     String   // META_ADS, GOOGLE, INSTAGRAM
  campaignName String?
  date         DateTime @db.Date
  spend        Decimal  @db.Decimal(10, 2)
  currency     String   @default("INR")
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([platform, campaignName, date])
  @@index([platform])
  @@index([date])
}
